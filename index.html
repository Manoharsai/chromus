<!DOCTYPE HTML>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/flexbox.css?rnd=1">
    <link rel="stylesheet" href="css/main.css?rnd=5">
    <link rel="stylesheet" href="css/mp3_player_button.css" type="text/css">
    <link rel="stylesheet" href="css/smoothness/jquery-ui.css" type="text/css">
    <link rel="stylesheet" href="css/jquery.lightbox.css" type="text/css">

    <script src="javascript/jquery.min.js"></script>
    <script src="javascript/jquery-ui.min.js"></script>
    <script src="javascript/jquery.lightbox.min.js"></script>

    <script src="javascript/id3.js"></script>
    
    <title>Chromus</title>
  </head>
  <body>
    <section id="main" style="height: 100%">    
      <div class="header dbg_r">      
            <div id="controls" class="float">
                <div class="controls_container float">
                    <img src="chromus_logo.png" width="50px" style="margin-bottom: 5px; margin-right: 20px;"/>
                    <a id="play" class="paused"><img src="images/play.png" alt="Play" width="58" height="58"/></a>
                    <a href="javascript:;" class="next" title="Next track"><img src="images/next_2.png" width="34px" style="margin-bottom: 12px;"/></a>
                    <a href="javascript:;" class="love" title="Love!" style="display: none"><img src="images/love.png" alt="Love!" width="28" /></a>
                    <!--<a href="javascript:;" class="ban" title="Ban track"><img src="/images/ban_2.png" alt="Ban" width="16" /></a>-->
                </div>
                <div class="buttons float">
                    <div class="album_image">
                        <img src="" alt="Album image" id="album_image" width="50" />
                    </div>
                </div>
                <div class="float track_info">
                    <a href="javascript:;" class="track" target="_blank"></a>
                    <div class="container">
                        <a href="javascript:;" class="artist" target="_blank"></a><span class="album_prefix">&nbsp;from</span>
                        <a href="javascript:;" class="album" target="_blank"></a>
                    </div>

                </div>
                <div class="float volume_control" style="width: 80px; padding-top: 10px;">
                    <div id="volume-slider" style="width: 80px;"></div>
                    <a href="javascript:;" class="volume_link"><img src="images/volume_2.png" alt="Volume" /></a>
                </div>
            </div>
            <div id="progress_bar">
                <div id="progress"></div>
                <div id="progress_loaded"></div>
            </div>
            <span class="time" id="track_time"></span>

      </div>
      <div class="container boxFlex1 dbg_g hbox" style="height: 100%; margin-top: 70px;">      
        <div class="panel dbg_b" style="padding:0; margin:0; border-right: 2px solid #ccc; padding-top: 10px; padding-left: 5px;">
          <label style="font-size: 20px; font-family: Verdana">Add local file to playlist</label>
          <input type="file" multiple onchange="onDirLoad(this)" id="add_file" value="Add file"/>

          <div style="font-size: 25px; text-align: left; height: 45px; margin-top: 40px; color: #333; font-familyt: Verdana">          
            Whats in development?
          </div>
          <div style="padding-left: 10px; padding-top: 10px; height: 45px; color: #fff; font-size: 30px; font-family: Arial; font-weight: bold;" class="service blogs">
            Podcasts
          </div>
          <div style="padding-left: 10px; padding-top: 10px; height: 45px; color: #fff; font-size: 30px; font-family: Arial; font-weight: bold;" class="service blogs">
            Music blogs
          </div>
          <div style="padding-left: 8px;" class="service lastfm">
              <img src="images/logos/lastfm_white.png" width="120px" style="margin-top: 10px;" />
          </div>
          <div style="padding-left: 8px;" class="service stereomood">
              <img src="images/logos/stereomood.gif" width="120px" />
          </div>
          <div style="padding-left: 10px;" class="service shoutcast">
              <img src="images/logos/shoutcast.png" width="180px" style="margin-top: 10px;" />              
          </div>
          <div style="padding-left: 12px;" class="service magnatune">
              <img src="images/logos/magnatune.gif" width="220px" style="margin-top: 15px;" />
          </div>
        </div>
        <ul class="playlist dbg_r boxFlex1" id="tracks_container" style="padding:0; margin:0;">         
        </ul>
        </div>
      </div>
    </section>
    <div class="play_mode_controls">
        <button id="play_mode_control" class="ui-toggler ui-corner-left shuffle disabled"></button>
        <button id="stop_after_control" class="ui-toggler stop_after_playing disabled"></button>
        <button id="repeat_mode_control" class="ui-toggler ui-corner-right repeat_mode disabled"></button>

        <input type="text" autocomplete="off" id="search" class="gray" />         

        <div id='scrobbling'>
            <button id="toggle_scrobbling" class="ui-toggler ui-corner-all toggle_scrobbling" style="display:none"></button>
            <a href="#" class="lfm_link" target="_blank" style="display:none">buger_swamp</a>
            <a href="javascript:;" class='connect_lfm' style="display:none">Want scrobbling?</a>
        </div>            
    </div>
    <div id="search_results" class="search_results" style="display: none">
    </div>

    <script src="javascript/content_script.js"></script>
    <script src="javascript/utils.js"></script>
    <script src="javascript/scrobbler.js"></script>
    <script src="javascript/main.js"></script>
    
    <script src="javascript/enhanced_play_button.js"></script>
    <script src="javascript/hotkeys.js"></script>

    <script>
      var music_manager = chrome.extension.getBackgroundPage().music_manager;

      new Autocompleter(document.getElementById('search'));

      function processFile(file){
          var reader = new FileReader();
          reader.readAsBinaryString(file); 

          reader.onload = function(evt){
              var dataReader = new ID3.binaryFileReader(evt.target.result);
              var tags = ID3.readID3Tags(dataReader);
              console.log("Tags:", tags);

              var base64reader = new FileReader(); 
              base64reader.readAsDataURL(file);

              base64reader.onloadend = function(evt){
                  console.log("Base64loaded");

                  if(tags.artist)
                      music_manager.playlist.push({
                          artist: tags.artist,                            
                          song: tags.title,
                          file_url: evt.target.result,
                          index: music_manager.playlist.length
                      })

                  updatePlaylist();
              }
          }
      }      

      function onDirLoad(input){
        var files = input.files;        
        console.log("files:", input.files);

        for(var i=0; i<files.length; i++){
            if(files[i] && files[i].name.match(/\.mp3$/)) {
                console.log("Name:", files[i].name, files[i]);                
      
                processFile(files[i]);
            }
         }
      }

/***************** From popup.html ***********************
  FIXME: Refactor this later
*/

    function helpOnHover(element, help){
        var help_func = function(){
            var help_text;

            if (typeof(help) == 'string'){
                help_text = help
            } else {
                help_text = help.call(element)
            }

            $('#quick_help').get(0).innerHTML = help_text
            $('#quick_help').show()

            element.title = help_text
        }

        element.mouseenter(help_func);
        element.click(help_func);
        element.mouseleave(function(){
            $('#quick_help').hide()
        })
    }



    music_manager.audio.addEventListener('onPlay', function(){
        var track = music_manager.playlist[music_manager.current_track]
        stopCurrentTrack()

        if(music_manager.current_track != undefined)
            if(track.not_found)
                try{document.getElementById("ex_button_"+music_manager.current_track).className = "sm2_button disabled"}catch(e){}
            else
                try{document.getElementById("ex_button_"+music_manager.current_track).className = "sm2_button playing"}catch(e){}
        
    }, true)

    music_manager.audio.addEventListener('onEnded', function(){
        stopCurrentTrack()
    }, true)

    music_manager.audio.addEventListener('onLoading', function(){
        if(music_manager.current_track != undefined)
            try{document.getElementById("ex_button_"+music_manager.current_track).className = "sm2_button loading"}catch(e){}

        updateTrackInfo()
    }, true)

    music_manager.audio.addEventListener('progress', function(){
        updateLoadProgress()
    })

    music_manager.audio.addEventListener('timeupdate', function(){
        updateProgress()
        updateLoadProgress()
    }, false)

    function updateProgress(){
        var progress = 0
        var loaded_progress = 0

        var track = music_manager.playlist[music_manager.current_track]

        if (track) {
          if (!track.duration){
            track.duration = music_manager.audio.duration;
          }
        }

        if(track)
            progress = (music_manager.audio.currentTime/track.duration)*100.0

        document.getElementById('progress').style.width = progress+'%'

        var track_time = document.querySelector('#track_time')
        if(track && track.duration)
            track_time.innerHTML = prettyTime(music_manager.audio.currentTime)+' /'+prettyTime(track.duration)
        else
            track_time.innerHTML = ""

    }

    function updateLoadProgress(){
        var track = music_manager.playlist[music_manager.current_track]

        if(track)
          try {
            loaded_progress = (music_manager.audio.buffered.end()/track.duration)*100.0
          } catch(e){
            loaded_progress = 0
          }

        document.getElementById('progress_loaded').style.width = loaded_progress+'%'
    }

    function removeFromPlaylist(link){
      var index = parseInt(link.getAttribute('data-index-number'))
      music_manager.playlist.splice(index, 1)

      link.parentNode.parentNode.removeChild(link.parentNode)

      updatePlaylist()
    }

    function updatePlaylist(){
        var container = document.getElementById('tracks_container')        
        var html = ""
        var state
        
        var playlist = music_manager.playlist

        for(var i=0; i<playlist.length; i++){
            if(music_manager.current_track != undefined && music_manager.current_track == i)
                state = music_manager.audio.paused ? "paused" : "playing"
            else
                state = playlist[i].not_found ? "disabled" : ""

                html += "<li>"+
                            "<a id='ex_button_"+playlist[i].index+"' data-index-number='"+playlist[i].index+"' href='javascript:;' onclick='togglePlaying(this)' class='sm2_button "+state+"'></a>"+
                            "<span class='track'>"

                if (!playlist[i].artist && playlist[i].file_url)
                  html += playlist[i].file_url
                else
                  html +=       "<a target='_blank' href='http://last.fm/music/"+playlist[i].artist.replace(/\s/g,'+')+"'>"+playlist[i].artist + "</a>" +
                                '  &ndash;  '+
                                "<a target='_blank' href=\"http://last.fm/music/"+playlist[i].artist.replace(/\s/g,'+')+"/_/"+(playlist[i].song||"").replace(/\s/g,'+')+"\">"+playlist[i].song+"</a>"+
                            "</span>"+
                            "<a href='javascript:;' title='Delete from playlist' data-index-number='"+playlist[i].index+"' onclick='removeFromPlaylist(this)' class='delete'></a>"
                        "</li>"
                
        }
        
        if(playlist.length == 0){
            html = "<li style='background: #fff; color: #333; padding: 10px;'>"+             
            "<h1>What can Chromus?</h1>"+
            "<h3 style='margin-top: 20px;'>Play local files (in left panel)</h3>"+
           
            "<h3 style='margin-top: 20px;'>Play music files from blogs or podcasts right in browser</h3>"+
            "<div style='margin-top: 10px;'><a href='tutorial/mp3_1.jpg' class='lightbox'><img style='border: 1px solid #ccc' src='tutorial/mp3_1_s.jpg'/></a><a href='tutorial/podcast_1.png' class='lightbox' style='margin-left: 50px;'><img style='border: 1px solid #ccc' src='tutorial/podcast_1_s.png'/></a></div>"+

            "<h3 style='margin-top: 20px;'>Quick music search on every page. Just select text and choose 'Search in Chromus' in context menu</h3>"+
            "<div style='margin-top: 10px;'><a href='tutorial/quick_search.jpg' class='lightbox'><img style='border: 1px solid #ccc' src='tutorial/quick_search_s.jpg'/></a></div>"+

            "<h3 style='margin-top: 20px;'>Integration with <a href='http://last.fm' style='font-size: 18px;'>www.last.fm</a></h3>"+
            "<div style='margin-top: 10px;'><img style='border: 1px solid #ccc' src='tutorial/lastfm.png'/></div>"+
            "</li>"
        }

        container.innerHTML = html

        $("a.lightbox").lightBox();
                
        if(music_manager.current_track != undefined && music_manager.current_track > 12)
            var playing_link = document.querySelector('a.sm2_button.playing, a.sm2_button.paused')
            
            if(playing_link)
                container.parentNode.scrollTop = playing_link.parentNode.offsetTop-120
    }
    

    function toggleScrobbling(event){
        var link = event.target
        
        if(link.className.match(/active/)){
            link.className = 'toggle_lfm'
        } else {
            link.className = 'toggle_lfm active'
        }
        
        music_manager.scrobbler.scrobbling = link.className.match(/active/)
        
        _gaq.push(['_trackEvent', 'controls', 'scrobbling', music_manager.scrobbler.scrobbling+'']);
    }   


    function trackLinks(track){
        if (!track.artist && track.file_url)
          return {}
        

        var artist_link = "http://last.fm/music/"+track.artist.replace(/\s/g,'+')
        var song_link = artist_link+"/_/"+track.song.replace(/\s/g,'+')
        if(track.album)
            var album_link = artist_link+"/"+track.album.replace(/\s/g,'+')

        return {
            artist: artist_link,
            track: song_link,
            album: album_link
        }
    }

    function updateTrackInfo(){
        var track = music_manager.playlist[music_manager.current_track]
        var play_btn = document.getElementById('play')

        if(track){
            document.querySelector('.track_info .container').style.visibility = 'visible'
            document.querySelector('.controls_container .love').style.visibility = 'visible'

            updateProgress()

            play_btn.style.display = 'inline'
            if(!music_manager.audio.paused){
                play_btn.querySelector('img').src = "images/pause.png"
                play_btn.className = "playing"
            } else {
                play_btn.querySelector('img').src = "images/play.png"
                play_btn.className = "paused"
            }

            if(track.image)
                document.querySelector("#controls #album_image").src = track.image

            var container = document.querySelector("#controls .track_info")
            var links = trackLinks(track)

            container.querySelector(".track").innerHTML = track.song
            container.querySelector(".track").href = links.track

            container.querySelector(".artist").innerHTML = track.artist
            container.querySelector(".artist").href = links.artist

            if(track.album){
                container.querySelector(".album").innerHTML = track.album
                container.querySelector(".album").href = links.album

                container.querySelector(".album_prefix").style.display = "inline"
                container.querySelector(".album").style.display = "inline"
            } else {
                container.querySelector(".album_prefix").style.display = "none"
                container.querySelector(".album").style.display = "none"
            }

            document.title = track.artist + ' - ' + track.song;
        } else {
            document.querySelector("#controls #album_image").src = "images/no_image.png"
            play_btn.style.display = 'none'

            //document.querySelector('.controls_container').style.visibility = 'hidden'
            //document.querySelector('.track_info').style.visibility = 'hidden'

            document.querySelector('.track_info .track').innerHTML = ""
            document.querySelector('.track_info .container').style.visibility = 'hidden'
            document.querySelector('.controls_container .love').style.visibility = 'hidden'

            document.title = 'Chromus';
        }

        updatePlaylist();
    }

    function onMouseWheel(evt){
      console.log(evt.wheelDelta)
    }
    window.addEventListener('DOMMouseScroll', onMouseWheel, false)

    function stopCurrentTrack(){
        var current_playing = document.querySelectorAll("a.sm2_button.playing, a.sm2_button.paused, a.sm2_button.loading")

        if(current_playing.length > 0)
            for(i in current_playing)
                current_playing[i].className = "sm2_button"
    }    
    
    function togglePlaying(link){
        if(link.className.match(/disabled/))
            return false
    
        if(link.className.match('playing')){
            link.className = "sm2_button paused"

            music_manager.pause()
        } else {
            if(link.className.match(/paused/)){
                link.className = "sm2_button playing"
            } else {                
                stopCurrentTrack()

                link.className = "sm2_button loading"                        
            }
            
            music_manager.play(music_manager.playlist[link.getAttribute('data-index-number')])
            
            _gaq.push(['_trackEvent', 'controls', 'togglePlaying', 'playlist']);
        }        

        updateTrackInfo()
    }

    function togglePlayingBig(evt){
        if(evt.target.nodeName == 'A'){
            var img = evt.target.querySelector('img')
            var button = evt.target
        } else {
            var img = evt.target
            var button = evt.target.parentNode
        }

        if(button.className.match(/playing/)){
            button.className = "paused"
            img.src = "images/play.png"
            music_manager.pause()
        } else {
            button.className = "playing"
            img.src = "images/pause.png"
            music_manager.audio.playOrLoad()
        }

        updatePlaylist()
        
        _gaq.push(['_trackEvent', 'controls', 'togglePlaying', 'big']);
    }

    function onLoad(){
        updatePlaylist()
        updateTrackInfo()


        /* Love & Ban buttons */
        var love_btn = document.querySelector('.controls_container .love')
        love_btn.addEventListener('click', function(evt){
            music_manager.love()
        }, false)

        if(music_manager.scrobbler._username){
            var link = document.querySelector('#scrobbling .lfm_link')
            link.innerHTML = music_manager.scrobbler._username
            link.href = "http://last.fm/user/"+music_manager.scrobbler._username


            var toggle_link = document.querySelector('#toggle_scrobbling')
            
            if(!music_manager.scrobbler.scrobbling)
                $(toggle_link).addClass('disabled');
            
            link.style.display = 'inline'
            toggle_link.style.display = 'inline'
        } else {
            var connect_lfm = document.querySelector('#scrobbling .connect_lfm')
            connect_lfm.style.display = 'inline'
            love_btn.style.display = 'none'

            connect_lfm.addEventListener('click', function(){music_manager.scrobbler.auth()}, false)
        }

        var play_btn = document.getElementById('play')
        play_btn.addEventListener('click', togglePlayingBig, false)
        

        var next_track = document.querySelector('.controls_container .next')
        next_track.addEventListener('click', function(){
            music_manager.playNextTrack(true)
            
            _gaq.push(['_trackEvent', 'controls', 'nextTrack']);
        }, false)
        
        var volume_toggle = document.querySelector('.volume_control .volume_link')
        volume_toggle.addEventListener('click', function(){
            var volume_range = $('#volume-slider')
            volume_range.slider("option", "value", 0)
            music_manager.setVolume(0)
            
            _gaq.push(['_trackEvent', 'controls', 'muteVolume']);
        })

        /* Progress bar */
        var progress = document.getElementById('progress_bar')
        progress.addEventListener('click', function(evt){
            var track = music_manager.playlist[music_manager.current_track]
            
            var progress = (evt.clientX/evt.target.offsetWidth)

            if(track)
                music_manager.audio.currentTime = track.duration * progress 
            
            _gaq.push(['_trackEvent', 'controls', 'progressChange']);
        }, false)
        

        var play_mode = $('#play_mode_control')
        var repeat_mode = $('#repeat_mode_control')
        var stop_after = $('#stop_after_control')

        if (music_manager.play_mode == "shuffle")
            play_mode.removeClass('disabled')

        if (music_manager.repeat_mode && music_manager.repeat_mode != "normal"){
            repeat_mode.removeClass('disabled')

            if (music_manager.repeat_mode == "repeat_all")
                repeat_mode.addClass('all')
        }

        if (music_manager.stop_after_playing == "stop")
            stop_after.removeClass('disabled')
    }

    onLoad();

  $(function() {
    $("#volume-slider").slider({
      orientation: "horizontal",
      range: "min",
      min: 0,
      max: 100,
      value: music_manager.getVolume()*100,
      slide: function(event, ui) {
        music_manager.setVolume(ui.value/100)
      }
    });


    $('button#play_mode_control').click(function(){
        $(this).toggleClass('disabled');

        music_manager.play_mode = $(this).hasClass('disabled') ? "normal" : "shuffle";
        
        _gaq.push(['_trackEvent', 'controls', 'playMode', music_manager.play_mode]);
    });

    helpOnHover($('button#play_mode_control'), function(){
        if ($(this).hasClass('disabled'))
            return "Shuffle mode disabled"
        else
            return "Shuffle mode enabled"
    })

    $('button#stop_after_control').click(function(){
        $(this).toggleClass('disabled');

        music_manager.stop_after_playing = $(this).hasClass('disabled') ? "normal" : "stop";

        _gaq.push(['_trackEvent', 'controls', 'playMode', music_manager.stop_after_playing]);
    });

    helpOnHover($('button#stop_after_control'), function(){
        if ($(this).hasClass('disabled'))
            return "Playing without stopping"
        else
            return "Stop after playing"
    })

      
      
    $('button#repeat_mode_control').click(function(){
        if ($(this).hasClass('all')){
          $(this).removeClass('all').addClass('disabled');
          music_manager.repeat_mode = "normal";
        } else if ($(this).hasClass('disabled')){
          $(this).removeClass('disabled all')
          music_manager.repeat_mode = "repeat_one";
        } else {
          $(this).removeClass('disabled').addClass('all');
            music_manager.repeat_mode = "repeat_all";
        }

        _gaq.push(['_trackEvent', 'controls', 'repeatMode', music_manager.repeat_mode]);
    });

    helpOnHover($('button#repeat_mode_control'), function(){
        if($(this).hasClass('all'))
          return "Repeat playlist"
        else if($(this).hasClass('disabled'))
          return "Don't repeat"
        else
          return "Repeat track"
    })


    $('button#toggle_scrobbling').click(function(){
        $(this).toggleClass('disabled')

        music_manager.scrobbler.scrobbling = !$(this).hasClass('disabled')
    })

    helpOnHover($('button#toggle_scrobbling'), function(){
        if($(this).hasClass('disabled'))
          return "Scrobbling disabled"
        else
          return "Scrobbling enabled"
    })
  });        


    document.body.addEventListener('click', function(evt){        
        if(!findParent(evt.target, 'search_results'))
            document.getElementById('search_results').style.display = 'none';
    }, false)

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-16810054-3']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_trackEvent', 'pageLoad', 'index']);

    </script>
    
    <div id="cmp_quick_search_results" class="dbg_r" style=""></div>
    <div id="quick_help" class="ui-corner-tr" style="position: fixed; background: #ddd; color: #666; bottom: 35px; left: 0px; padding: 3px;display: none; max-width: 200px; overflow:hidden;text-overflow: ellipsis; z-index: 9999; font-size: 12px;"></div>
  </body>
</html>
