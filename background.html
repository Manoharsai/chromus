<html>
    <head>
    <script src="javascript/xml2json.js"></script>
    <!--<script src="javascript/sm2.js"></script>
    <script>
      soundManager.url = 'http://soundmanagercache.googlecode.com/svn/trunk/';
    </script>
    -->
    <script src="javascript/md5.js"></script>
    <script src="javascript/id3.js"></script>
    <script src="javascript/cache.js"></script>
    <script src="javascript/utils.js?rnd=6"></script>    
    <script src="javascript/scrobbler.js?rnd=13"></script>
    <script src="javascript/vk.js?rnd=15"></script>
    <script src="javascript/music_manager.js?rnd=21"></script>
    <script src="javascript/browser_detect.js?rnd=1"></script>
    <script> 
    function ease(x) {
      return (1-Math.sin(Math.PI/2+x*Math.PI))/2;
    }
    
    var rotation = 0
    var animationSpeed = 10
    var animationFrames = 26
    var canvasContext
    var canvas

    function animateFlip() {
      try {
          chrome.browserAction;
      } catch(e) {
          return false;
      }

      rotation += 1/animationFrames;
      drawIconAtRotation();

      if (rotation <= 1) {
        setTimeout(animateFlip, animationSpeed);
      } else {
        rotation = 0;

        chrome.browserAction.setIcon({path:chrome.extension.getURL('chromus_logo.png')});
      }
    }

    function drawIconAtRotation() {
      try {
          chrome.browserAction;
      } catch(e) {
          return false;
      }

   
      canvasContext.save();
      canvasContext.clearRect(0, 0, canvas.width, canvas.height);
      canvasContext.translate(
          Math.ceil(canvas.width/2),
          Math.ceil(canvas.height/2));
      canvasContext.rotate(2*Math.PI*ease(rotation));
      canvasContext.drawImage(document.getElementById('lastfm_icon'),
          -Math.ceil(canvas.width/2),
          -Math.ceil(canvas.height/2));
      canvasContext.restore()

      chrome.browserAction.setIcon({imageData:canvasContext.getImageData(0, 0, canvas.width,canvas.height)});
    }

    chrome.browserAction.setBadgeBackgroundColor({color:[51,153,204,255]}) //blue
    
    var scrobbler = new Scrobbler(window.localStorage["lastfm_session"], window.localStorage["lastfm_username"])

    var music_manager = new MusicManager(scrobbler);
    var popup_port;

    function postBroadcastMessage(msg){
        if(active_port)
            active_port.postMessage(msg);
        
        if(popup_port)
            popup_port.postMessage(msg);
    }

    music_manager.dispatcher.addEventListener('onPlay', function(){
        var track = music_manager.playlist[music_manager.current_track]

        if(!track.not_found)
            chrome.browserAction.setTitle({title: track.artist +' - '+ track.song})       

        if(active_port){
            if(track.not_found)
                active_port.postMessage({method:"readyToPlay", error:'not_found', element_id: track.element_id})
            else
                active_port.postMessage({method:"readyToPlay", element_id:track.element_id})
        }
    }, true)

    music_manager.dispatcher.addEventListener('onEnded', function(){
    chrome.browserAction.setBadgeText({text:''})

        if(active_port)
            active_port.postMessage({method:"stop"})
    }, true)

    music_manager.dispatcher.addEventListener('onLoading', function(){
        var track = music_manager.playlist[music_manager.current_track]

        if(active_port && track.element_id)
            postBroadcastMessage({method:"loading", element_id:track.element_id, track: music_manager.current_track})
    }, true)

    
    function updateTime(){
        try {
          chrome.browserAction
        } catch(e){
            return false;
        }

        var track = music_manager.playlist[music_manager.current_track]

        if(track && !track.duration)
          track.duration = music_manager.audio.duration

        if(!music_manager.audio.paused){
            if(music_manager.audio.duration && track && track.duration && music_manager.audio.currentTime){
                var time_left = track.duration - music_manager.audio.currentTime

                if(time_left > 0)
                    chrome.browserAction.setBadgeText({text:prettyTime(time_left)})
                else
                    chrome.browserAction.setBadgeText({text:""})
            } else {
                chrome.browserAction.setBadgeText({text:""})
            }
        }

        postBroadcastMessage({
            method:'updateState',
            state: music_manager.getState()            
        });

        setTimeout(updateTime, 1000)
    }
    
    var connected_ports = []

    var active_port

    function onLoad(){    
        updateTime()

        canvas = document.getElementById('canvas')
        canvasContext = canvas.getContext('2d')

        chrome.extension.onConnect.addListener(function(port) {
            console.log("Connected:", port)
            
            if(port.name == "popup")
                popup_port = port

            connected_ports.push(port)            

            port.onMessage.addListener(function(msg) {
                console.log(msg.method, msg)

                _gaq.push(['_trackEvent', 'msgReceived', msg.method]);

                switch(msg.method){
                    case "auth_token":
                        scrobbler.getSession(msg.token, function(response){
                            console.log("Getting session:", response)

                            if(response.session){
                                window.localStorage['lastfm_session'] = response.session
                                window.localStorage['lastfm_username'] = response.username
                            }
                            
                            chrome.tabs.update(port.tab.id, {url:chrome.extension.getURL("options.html")})
                        });

                        break;                        

                    case "logout": 
                        scrobbler._username = null;
                        scrobbler._session_key = null;

                        break;                    

                    case "pause": 
                        music_manager.pause();

                        break;

                    case "play":
                        if(active_port && active_port != port && port.name != "popup")
                            active_port.postMessage({method:"stop"})                    
    
                        if(port.name != "popup")
                            active_port = port

                        if(msg.playlist) {
                            music_manager.playlist = msg.playlist
                            delete music_manager.current_track
                        }

                        if(typeof(msg.track) == "number")
                            msg.track = music_manager.playlist[msg.track];

                        music_manager.play(msg.track)

                        break;

                    case "add_to_playlist":
                        var track = msg.track;
                        track.index = music_manager.playlist.length;

                        music_manager.playlist.push(track);
                        music_manager.updateID3Info(music_manager.playlist.length-1);

                        break;
        
                    case "search":
                        Scrobbler.search(msg.search_text, function(response){                  
                            port.postMessage({method:"searchResult", html:response.html});
                        });

                        break;

                    case "togglePlaying":
                        if(music_manager.audio.paused && music_manager.current_track) {
                            music_manager.audio.playOrLoad();
                        } else {
                            music_manager.audio.pause();
                        }

                        break;

                    case "nextTrack": 
                        music_manager.playNextTrack(true);

                        break;
                    
                    case "previousTrack":
                        music_manager.playNextTrack(true, true);

                        break;

                    case "getPlaylist":
                        port.postMessage({
                            method: "loadPlaylist", 
                            playlist: music_manager.playlist, 
                            current_track: music_manager.current_track,
                            state: music_manager.getState()
                        });

                        break;
            
                    case "setVolume":
                        music_manager.setVolume(msg.volume);

                        break;

                    default:
                        console.log("Unknown message", msg);
                        break;
                }                  
            })

            port.onDisconnect.addListener(function(msg){
                if(port.name == "popup")
                    delete popup_port
                else {
                    var index = connected_ports.indexOf(port)
                    if(index >= 0)
                        connected_ports.splice(index, 1)
                }
            })


            search_pattern = window.localStorage["search_pattern"]                            
            if(search_pattern == undefined)
                search_pattern = "http://vkontakte.ru/gsearch.php?section=audio&q=%s"
            
            if(!port.reconnect)
                port.postMessage({method:'setSettings', 
                                  search_pattern: search_pattern, 
                                  external_audio_search: window.localStorage["external_search"]})
        })
        
       // _gaq.push(['_trackPageview']);
    }

    function searchMenuClick(info, tab) {
        console.log("info: ", info);
        console.log("tab: ", tab);
        console.log("Connected ports: ", connected_ports);

        var port;

        for(i in connected_ports)
            if(connected_ports[i].tab && connected_ports[i].tab.id == tab.id){
                port = connected_ports[i]
                break;
            }

        Scrobbler.search(info.selectionText, function(response){ 
            port.postMessage({method:"searchResult", html:response.html});
        })
    }


    chrome.contextMenus.create({
      "title": "Search in Chromus", 
      "onclick": searchMenuClick,
      "contexts":["selection"]
    });

    chrome.tabs.onSelectionChanged.addListener(function(tab_id, select_info){      
        console.log("Tab selected", tab_id, select_info);
    })
</script>

    </head>
    <body onload="onLoad()">
      <div id="vk_search"></div>
      <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-16810054-3']);
      _gaq.push(['_trackPageview']);
      _gaq.push(['_trackEvent', 'pageLoad', 'background', '2.8.20']);      

      if(BrowserDetect.OS != 'Mac' && BrowserDetect.OS != 'Linux'){      
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = 'https://ssl.google-analytics.com/ga.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        })();
      }
      </script>

      <img id="lastfm_icon" src="chromus_logo.png" width="19" height="19"/>
      <canvas id="canvas" width="19" height="19" />
    </body>
</html>
